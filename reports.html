<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - School Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            line-height: 1.6;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 30px;
        }
        
        /* Controls */
        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-range input,
        .date-range select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .export-controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-info {
            background: #2196F3;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .card-header h3 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }
        
        .card-header p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .card-body {
            padding: 25px;
        }
        
        /* Chart containers */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .chart-small {
            height: 200px;
        }
        
        /* Statistics Cards */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        /* Class Performance Table */
        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .performance-table th,
        .performance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .performance-table th {
            background: #f8f9ff;
            color: #333;
            font-weight: 600;
        }
        
        .performance-table tr:hover {
            background: #f8f9ff;
        }
        
        .grade-badge {
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
        }
        
        .grade-a { background: #4CAF50; }
        .grade-b { background: #2196F3; }
        .grade-c { background: #FF9800; }
        .grade-d { background: #FF5722; }
        .grade-f { background: #f44336; }
        
        /* Attendance insights */
        .attendance-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .insight-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .insight-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .insight-value {
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
        }
        
        /* Export section */
        .export-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-top: 30px;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .export-card {
            border: 2px dashed #ddd;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .export-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .export-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .date-range {
                flex-direction: column;
                width: 100%;
            }
            
            .export-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
            <h1>üìä Reports & Analytics</h1>
            <div></div>
        </div>
    </header>

    <div class="container">
        <!-- Controls -->
        <div class="controls">
            <div class="date-range">
                <label>Time Period:</label>
                <select id="timePeriod" onchange="updateReports()">
                    <option value="all">All Time</option>
                    <option value="month">This Month</option>
                    <option value="week">This Week</option>
                    <option value="custom">Custom Range</option>
                </select>
                <input type="date" id="startDate" style="display: none;">
                <input type="date" id="endDate" style="display: none;">
            </div>
            <div class="export-controls">
                <button class="btn btn-success" onclick="exportToCSV('all')">üìÑ Export CSV</button>
                <button class="btn btn-info" onclick="exportToPDF()">üìã Export PDF</button>
                <button class="btn btn-primary" onclick="updateReports()">üîÑ Refresh</button>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-number" id="totalActiveStudents">0</div>
                <div class="stat-label">Active Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üè´</div>
                <div class="stat-number" id="totalClasses">0</div>
                <div class="stat-label">Total Classes</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìö</div>
                <div class="stat-number" id="totalAssignments">0</div>
                <div class="stat-label">Total Assignments</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-number" id="overallAverage">0%</div>
                <div class="stat-label">Overall Average</div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-grid">
            <!-- Grade Distribution Chart -->
            <div class="card">
                <div class="card-header">
                    <h3>üìä Grade Distribution</h3>
                    <p>Distribution of letter grades across all classes</p>
                </div>
                <div class="card-body">
                    <div class="chart-container chart-small">
                        <canvas id="gradeDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Attendance Overview -->
            <div class="card">
                <div class="card-header">
                    <h3>üìÖ Attendance Overview</h3>
                    <p>Overall attendance statistics</p>
                </div>
                <div class="card-body">
                    <div class="chart-container chart-small">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Class Performance -->
            <div class="card">
                <div class="card-header">
                    <h3>üèÜ Class Performance</h3>
                    <p>Average performance by class</p>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="classPerformanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Attendance Trends -->
            <div class="card">
                <div class="card-header">
                    <h3>üìà Attendance Trends</h3>
                    <p>Attendance rates over time</p>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="attendanceTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Reports -->
        <div class="dashboard-grid">
            <!-- Top Performers -->
            <div class="card">
                <div class="card-header">
                    <h3>üåü Top Performers</h3>
                    <p>Students with highest grades</p>
                </div>
                <div class="card-body">
                    <table class="performance-table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Average</th>
                                <th>Grade</th>
                                <th>Class</th>
                            </tr>
                        </thead>
                        <tbody id="topPerformersTable">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Attendance Insights -->
            <div class="card">
                <div class="card-header">
                    <h3>üîç Attendance Insights</h3>
                    <p>Key attendance metrics</p>
                </div>
                <div class="card-body">
                    <div class="attendance-insights" id="attendanceInsights">
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <h3>üì• Export Reports</h3>
            <p>Download comprehensive reports in various formats</p>
            
            <div class="export-options">
                <div class="export-card" onclick="exportToCSV('grades')">
                    <div class="export-icon">üìä</div>
                    <h4>Grade Reports</h4>
                    <p>Export all student grades and averages</p>
                    <button class="btn btn-success">Download CSV</button>
                </div>
                
                <div class="export-card" onclick="exportToCSV('attendance')">
                    <div class="export-icon">üìÖ</div>
                    <h4>Attendance Reports</h4>
                    <p>Export attendance records and statistics</p>
                    <button class="btn btn-success">Download CSV</button>
                </div>
                
                <div class="export-card" onclick="exportToCSV('students')">
                    <div class="export-icon">üë•</div>
                    <h4>Student Profiles</h4>
                    <p>Export complete student information</p>
                    <button class="btn btn-success">Download CSV</button>
                </div>
                
                <div class="export-card" onclick="exportToPDF()">
                    <div class="export-icon">üìã</div>
                    <h4>Summary Report</h4>
                    <p>Complete analytics report in PDF format</p>
                    <button class="btn btn-info">Download PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase and Services -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./assets/js/services/AuthService.js"></script>
    <script src="./assets/js/services/DataService.js"></script>

    <script>
        class ReportsSystem {
            constructor() {
                this.classRecords = {};
                this.attendanceData = {};
                this.studentProfiles = {};
                this.charts = {};
                this.init();
            }

            async init() {
                await this.loadData();
                this.setupEventListeners();
                this.generateReports();
            }

            setupEventListeners() {
                document.getElementById('timePeriod').addEventListener('change', (e) => {
                    const customDates = document.querySelectorAll('#startDate, #endDate');
                    if (e.target.value === 'custom') {
                        customDates.forEach(input => input.style.display = 'inline-block');
                    } else {
                        customDates.forEach(input => input.style.display = 'none');
                    }
                });
            }

            async loadData() {
                try {
                    if (window.authService) {
                        await window.authService.initialize();
                        const ok = await window.authService.requireAuth();
                        if (!ok) return;
                    }
                    if (window.dataService) {
                        await window.dataService.initialize();
                        this.classRecords = await window.dataService.getClassRecords();
                        this.attendanceData = await window.dataService.getAttendance();
                        this.studentProfiles = await window.dataService.getStudentProfiles();
                    }
                } catch (e) {
                    console.warn('Error loading cloud data for reports:', e.message);
                }
            }

            generateReports() {
                this.updateStatistics();
                this.createGradeDistributionChart();
                this.createAttendanceChart();
                this.createClassPerformanceChart();
                this.createAttendanceTrendChart();
                this.updateTopPerformers();
                this.updateAttendanceInsights();
            }

            updateStatistics() {
                let totalStudents = 0;
                let totalClasses = Object.keys(this.classRecords).length;
                let totalAssignments = 0;
                let gradeSum = 0;
                let gradeCount = 0;

                // Calculate from class records
                Object.values(this.classRecords).forEach(classData => {
                    totalStudents += classData.students.length;
                    totalAssignments += classData.assignments.length;
                    
                    classData.students.forEach(student => {
                        Object.values(student.grades).forEach(grade => {
                            gradeSum += grade;
                            gradeCount++;
                        });
                    });
                });

                const overallAverage = gradeCount > 0 ? (gradeSum / gradeCount).toFixed(1) : 0;

                document.getElementById('totalActiveStudents').textContent = totalStudents;
                document.getElementById('totalClasses').textContent = totalClasses;
                document.getElementById('totalAssignments').textContent = totalAssignments;
                document.getElementById('overallAverage').textContent = overallAverage + '%';
            }

            createGradeDistributionChart() {
                const ctx = document.getElementById('gradeDistributionChart').getContext('2d');
                
                const gradeDistribution = { A: 0, B: 0, C: 0, D: 0, F: 0 };
                
                Object.values(this.classRecords).forEach(classData => {
                    classData.students.forEach(student => {
                        const grades = Object.values(student.grades);
                        if (grades.length > 0) {
                            const average = grades.reduce((sum, grade) => sum + grade, 0) / grades.length;
                            const letter = this.getLetterGrade(average);
                            gradeDistribution[letter]++;
                        }
                    });
                });

                if (this.charts.gradeDistribution) {
                    this.charts.gradeDistribution.destroy();
                }

                this.charts.gradeDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['A (90-100%)', 'B (80-89%)', 'C (70-79%)', 'D (60-69%)', 'F (0-59%)'],
                        datasets: [{
                            data: [gradeDistribution.A, gradeDistribution.B, gradeDistribution.C, gradeDistribution.D, gradeDistribution.F],
                            backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#FF5722', '#f44336'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            createAttendanceChart() {
                const ctx = document.getElementById('attendanceChart').getContext('2d');
                
                let present = 0, absent = 0, tardy = 0;
                
                Object.values(this.attendanceData).forEach(classData => {
                    if (classData && classData.students) {
                        classData.students.forEach(student => {
                            if (student.status === 'present') present++;
                            else if (student.status === 'absent') absent++;
                            else if (student.status === 'tardy') tardy++;
                        });
                    }
                });

                if (this.charts.attendance) {
                    this.charts.attendance.destroy();
                }

                this.charts.attendance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Present', 'Absent', 'Tardy'],
                        datasets: [{
                            data: [present, absent, tardy],
                            backgroundColor: ['#4CAF50', '#f44336', '#FF9800'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            createClassPerformanceChart() {
                const ctx = document.getElementById('classPerformanceChart').getContext('2d');
                
                const classAverages = {};
                
                Object.keys(this.classRecords).forEach(className => {
                    const classData = this.classRecords[className];
                    let gradeSum = 0;
                    let gradeCount = 0;
                    
                    classData.students.forEach(student => {
                        Object.values(student.grades).forEach(grade => {
                            gradeSum += grade;
                            gradeCount++;
                        });
                    });
                    
                    classAverages[className] = gradeCount > 0 ? gradeSum / gradeCount : 0;
                });

                if (this.charts.classPerformance) {
                    this.charts.classPerformance.destroy();
                }

                this.charts.classPerformance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(classAverages),
                        datasets: [{
                            label: 'Class Average (%)',
                            data: Object.values(classAverages),
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            createAttendanceTrendChart() {
                const ctx = document.getElementById('attendanceTrendChart').getContext('2d');
                
                // Generate mock trend data (in a real app, this would be historical data)
                const labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'];
                const attendanceRates = [92, 89, 94, 91, 88, 93]; // Mock data

                if (this.charts.attendanceTrend) {
                    this.charts.attendanceTrend.destroy();
                }

                this.charts.attendanceTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Attendance Rate (%)',
                            data: attendanceRates,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            updateTopPerformers() {
                const students = [];
                
                Object.keys(this.classRecords).forEach(className => {
                    const classData = this.classRecords[className];
                    classData.students.forEach(student => {
                        const grades = Object.values(student.grades);
                        if (grades.length > 0) {
                            const average = grades.reduce((sum, grade) => sum + grade, 0) / grades.length;
                            
                            // Get additional details from student profiles
                            const profile = this.studentProfiles[student.id] || {};
                            const isActive = !profile.enrollmentStatus || profile.enrollmentStatus === 'Active';
                            
                            // Only include active students
                            if (isActive) {
                                students.push({
                                    name: student.name,
                                    average: average,
                                    letterGrade: this.getLetterGrade(average),
                                    gradeLevel: profile.gradeLevel || 'N/A',
                                    section: profile.section || 'N/A',
                                    className: className
                                });
                            }
                        }
                    });
                });

                // Sort by average and take top 10
                students.sort((a, b) => b.average - a.average);
                const topStudents = students.slice(0, 10);

                const tableBody = document.getElementById('topPerformersTable');
                tableBody.innerHTML = topStudents.map((student, index) => `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${student.name}</div>
                            <small style="color: #666;">Grade ${student.gradeLevel} - Section ${student.section}</small>
                        </td>
                        <td>${student.average.toFixed(1)}%</td>
                        <td><span class="grade-badge ${this.getGradeClass(student.average)}">${student.letterGrade}</span></td>
                        <td style="font-size: 12px; color: #666;">${student.className}</td>
                    </tr>
                `).join('');
            }

            updateAttendanceInsights() {
                let totalRecords = 0;
                let presentCount = 0;
                let absentCount = 0;
                let tardyCount = 0;

                Object.values(this.attendanceData).forEach(classData => {
                    if (classData && classData.students) {
                        classData.students.forEach(student => {
                            totalRecords++;
                            if (student.status === 'present') presentCount++;
                            else if (student.status === 'absent') absentCount++;
                            else if (student.status === 'tardy') tardyCount++;
                        });
                    }
                });

                const attendanceRate = totalRecords > 0 ? ((presentCount / totalRecords) * 100).toFixed(1) : 0;
                const absenteeRate = totalRecords > 0 ? ((absentCount / totalRecords) * 100).toFixed(1) : 0;

                const insights = document.getElementById('attendanceInsights');
                insights.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-title">Overall Attendance Rate</div>
                        <div class="insight-value">${attendanceRate}%</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-title">Total Present</div>
                        <div class="insight-value">${presentCount}</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-title">Total Absent</div>
                        <div class="insight-value">${absentCount}</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-title">Chronic Absences</div>
                        <div class="insight-value">${absenteeRate}%</div>
                    </div>
                `;
            }

            getLetterGrade(average) {
                if (average >= 90) return 'A';
                if (average >= 80) return 'B';
                if (average >= 70) return 'C';
                if (average >= 60) return 'D';
                return 'F';
            }

            getGradeClass(average) {
                if (average >= 90) return 'grade-a';
                if (average >= 80) return 'grade-b';
                if (average >= 70) return 'grade-c';
                if (average >= 60) return 'grade-d';
                return 'grade-f';
            }

            exportToCSV(type) {
                let csvContent = '';
                let filename = '';

                switch (type) {
                    case 'grades':
                        csvContent = this.generateGradeCSV();
                        filename = `grade-report-${new Date().toISOString().split('T')[0]}.csv`;
                        break;
                    case 'attendance':
                        csvContent = this.generateAttendanceCSV();
                        filename = `attendance-report-${new Date().toISOString().split('T')[0]}.csv`;
                        break;
                    case 'students':
                        csvContent = this.generateStudentCSV();
                        filename = `student-profiles-${new Date().toISOString().split('T')[0]}.csv`;
                        break;
                    case 'all':
                        csvContent = this.generateSummaryCSV();
                        filename = `school-summary-${new Date().toISOString().split('T')[0]}.csv`;
                        break;
                }

                this.downloadCSV(csvContent, filename);
            }

            generateGradeCSV() {
                let csv = 'Class,Student Name,Student ID,Assignment,Grade,Letter Grade\n';
                
                Object.keys(this.classRecords).forEach(className => {
                    const classData = this.classRecords[className];
                    classData.students.forEach(student => {
                        Object.keys(student.grades).forEach(assignment => {
                            const grade = student.grades[assignment];
                            const letterGrade = this.getLetterGrade(grade);
                            csv += `"${className}","${student.name}","${student.id}","${assignment}","${grade}","${letterGrade}"\n`;
                        });
                    });
                });

                return csv;
            }

            generateAttendanceCSV() {
                let csv = 'Class,Student Name,Student ID,Status,Date\n';
                
                Object.keys(this.attendanceData).forEach(className => {
                    const classData = this.attendanceData[className];
                    if (classData && classData.students) {
                        classData.students.forEach(student => {
                            const date = classData.date || new Date().toLocaleDateString();
                            csv += `"${className}","${student.name}","${student.id}","${student.status || 'Not Recorded}","${date}"\n`;
                        });
                    }
                });

                return csv;
            }

            generateStudentCSV() {
                let csv = 'Student Name,Student ID,Classes,Grade Average,Letter Grade,Attendance Rate\n';
                
                const studentMap = new Map();
                
                // Compile student data
                Object.keys(this.classRecords).forEach(className => {
                    const classData = this.classRecords[className];
                    classData.students.forEach(student => {
                        const key = `${student.name}_${student.id}`;
                        if (!studentMap.has(key)) {
                            studentMap.set(key, {
                                name: student.name,
                                id: student.id,
                                classes: [],
                                grades: [],
                                attendance: { present: 0, absent: 0, tardy: 0 }
                            });
                        }
                        
                        const profile = studentMap.get(key);
                        profile.classes.push(className);
                        profile.grades.push(...Object.values(student.grades));
                    });
                });

                // Add attendance data
                Object.keys(this.attendanceData).forEach(className => {
                    const attendanceClass = this.attendanceData[className];
                    if (attendanceClass && attendanceClass.students) {
                        attendanceClass.students.forEach(student => {
                            const key = `${student.name}_${student.id}`;
                            if (studentMap.has(key)) {
                                const profile = studentMap.get(key);
                                if (student.status === 'present') profile.attendance.present++;
                                else if (student.status === 'absent') profile.attendance.absent++;
                                else if (student.status === 'tardy') profile.attendance.tardy++;
                            }
                        });
                    }
                });

                studentMap.forEach(student => {
                    const average = student.grades.length > 0 ? 
                        student.grades.reduce((sum, grade) => sum + grade, 0) / student.grades.length : 0;
                    const letterGrade = this.getLetterGrade(average);
                    const attendanceTotal = student.attendance.present + student.attendance.absent + student.attendance.tardy;
                    const attendanceRate = attendanceTotal > 0 ? 
                        ((student.attendance.present / attendanceTotal) * 100).toFixed(1) : 0;
                    
                    csv += `"${student.name}","${student.id}","${student.classes.join('; ')}","${average.toFixed(1)}","${letterGrade}","${attendanceRate}%"\n`;
                });

                return csv;
            }

            generateSummaryCSV() {
                let csv = 'School Summary Report\n';
                csv += `Generated: ${new Date().toLocaleString()}\n\n`;
                
                csv += 'OVERVIEW\n';
                csv += 'Metric,Value\n';
                csv += `Total Classes,${Object.keys(this.classRecords).length}\n`;
                
                let totalStudents = 0;
                let totalAssignments = 0;
                Object.values(this.classRecords).forEach(classData => {
                    totalStudents += classData.students.length;
                    totalAssignments += classData.assignments.length;
                });
                
                csv += `Total Students,${totalStudents}\n`;
                csv += `Total Assignments,${totalAssignments}\n\n`;
                
                return csv;
            }

            downloadCSV(content, filename) {
                const blob = new Blob([content], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showNotification(`üìÑ ${filename} downloaded successfully!`);
            }

            exportToPDF() {
                // Simple PDF generation using window.print with specific styling
                const printWindow = window.open('', '_blank');
                printWindow.document.write(this.generatePDFContent());
                printWindow.document.close();
                printWindow.print();
                
                this.showNotification('üìã PDF report generated! Please check your print dialog.');
            }

            generatePDFContent() {
                const stats = {
                    totalStudents: document.getElementById('totalActiveStudents').textContent,
                    totalClasses: document.getElementById('totalClasses').textContent,
                    totalAssignments: document.getElementById('totalAssignments').textContent,
                    overallAverage: document.getElementById('overallAverage').textContent
                };

                return `
                    <html>
                    <head>
                        <title>School Platform Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .stats { display: flex; justify-content: space-around; margin: 20px 0; }
                            .stat { text-align: center; }
                            .stat-number { font-size: 24px; font-weight: bold; color: #667eea; }
                            .section { margin: 20px 0; }
                            h1, h2 { color: #333; }
                            table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                            th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                            th { background-color: #f8f9ff; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>üìö School Platform Report</h1>
                            <p>Generated on ${new Date().toLocaleString()}</p>
                        </div>
                        
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-number">${stats.totalStudents}</div>
                                <div>Active Students</div>
                            </div>
                            <div class="stat">
                                <div class="stat-number">${stats.totalClasses}</div>
                                <div>Total Classes</div>
                            </div>
                            <div class="stat">
                                <div class="stat-number">${stats.totalAssignments}</div>
                                <div>Total Assignments</div>
                            </div>
                            <div class="stat">
                                <div class="stat-number">${stats.overallAverage}</div>
                                <div>Overall Average</div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h2>Summary</h2>
                            <p>This report provides an overview of academic performance and attendance across all classes in the School Platform system.</p>
                        </div>
                    </body>
                    </html>
                `;
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #4CAF50, #45a049);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                    z-index: 1000;
                    font-weight: 600;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 4000);
            }

            updateReports() {
                this.generateReports();
                this.showNotification('üîÑ Reports updated successfully!');
            }
        }

        // Initialize the system
        const reportsSystem = new ReportsSystem();

        // Global functions
        function updateReports() {
            reportsSystem.updateReports();
        }

        function exportToCSV(type) {
            reportsSystem.exportToCSV(type);
        }

        function exportToPDF() {
            reportsSystem.exportToPDF();
        }
    </script>
</body>
</html>